<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chỉ huy</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body>
<header>
  <div class="title">Chỉ huy (Realtime)</div>
  <div class="right">
    <span id="who" class="badge"></span>
    <button class="secondary" id="btnLogout" style="display:none">Đăng xuất</button>
  </div>
</header>
<div class="container">

<div class="card">
  <h2 style="margin:0 0 8px 0;">Theo dõi chỉ huy (thời gian thực)</h2>
  <small>Chỉ xem – không có chức năng duyệt.</small>
  <hr/>
  <div class="row">
    <div class="col">
      <div><b>Kết nối:</b> <span id="conn">-</span></div>
      <div><b>Lần cập nhật:</b> <span id="last">-</span></div>
    </div>
    <div class="col">
      <div><b>Tổng hôm nay:</b> <span id="sumToday" class="badge">-</span></div>
      <div><b>Đang ở trong:</b> <span id="sumIn" class="badge in">-</span></div>
    </div>
  </div>
</div>

<div class="card">
  <h3 style="margin:0 0 8px 0;">Chờ duyệt (PENDING)</h3>
  <table id="tblPending"></table>
</div>

<div class="card">
  <h3 style="margin:0 0 8px 0;">Đang trong đơn vị (IN)</h3>
  <table id="tblIn"></table>
</div>

</div>
<div id="toast" class="toast"></div>
<script src="assets/app.js"></script>

<script>
(function(){
  requireAuth(["commander","admin","duty"]);
  $("who").textContent = (getRole()||"") + " • " + (getUser()||"");
  $("btnLogout").style.display = "inline-block";
  $("btnLogout").addEventListener("click", ()=>{ clearAuth(); window.location.href="index.html"; });

  let since = "";
  let all = {};

  function normalizeRow(r){
    return {
      visit_id: r.visit_id||"",
      gate: r.gate||"",
      fullname: r.fullname||"",
      birth_year: r.birth_year||"",
      cccd: r.cccd||"",
      address: r.address||"",
      soldier_name: r.soldier_name||"",
      relationship: r.relationship||"",
      status: r.status||"",
      created_at: r.created_at||"",
      approved_at: r.approved_at||"",
      approved_by: r.approved_by||"",
      checkout_at: r.checkout_at||"",
      checkout_by: r.checkout_by||"",
      last_updated_at: r.last_updated_at||""
    };
  }

  function render(){
    const rows = Object.values(all);
    const pending = rows.filter(r=>r.status==="PENDING").sort((a,b)=> (b.created_at||"").localeCompare(a.created_at||""));
    const ins = rows.filter(r=>r.status==="IN").sort((a,b)=> (b.approved_at||"").localeCompare(a.approved_at||""));

    renderTable($("tblPending"), pending.slice(0, 30), [
      {label:"Thời gian", value:r=>fmtTime(r.created_at)},
      {label:"Khách", value:r=>`${r.fullname} (${r.birth_year||""})`},
      {label:"CCCD", value:"cccd"},
      {label:"Quân nhân", value:"soldier_name"},
      {label:"Quan hệ", value:"relationship"},
      {label:"Cổng", value:"gate"},
    ]);

    renderTable($("tblIn"), ins.slice(0, 50), [
      {label:"Vào lúc", value:r=>fmtTime(r.approved_at)},
      {label:"Khách", value:"fullname"},
      {label:"CCCD", value:"cccd"},
      {label:"Quân nhân", value:"soldier_name"},
      {label:"Cổng", value:"gate"},
    ]);

    // Summaries
    const today = new Date();
    const ymd = today.toISOString().slice(0,10);
    const totalToday = rows.filter(r => (r.created_at||"").startsWith(ymd)).length;
    $("sumToday").textContent = String(totalToday);
    $("sumIn").textContent = String(ins.length);
  }

  async function refreshOnce(){
    try{
      const r = await apiGet("realtime", { since }, true);
      if(!r.ok) throw new Error(r.error||"realtime error");
      $("conn").textContent = "OK";
      $("last").textContent = fmtTime(r.server_time || nowISO());
      (r.items||[]).forEach(item=>{
        const row = normalizeRow(item);
        all[row.visit_id] = row;
      });
      since = r.server_time || nowISO();
      render();
    }catch(e){
      $("conn").textContent = "Lỗi";
    }
  }

  (async ()=>{
    const snap = await apiGet("snapshot", {}, true);
    if(snap.ok){
      all = {};
      (snap.items||[]).forEach(it=>{ const r = normalizeRow(it); all[r.visit_id]=r; });
      since = snap.server_time || nowISO();
      render();
    }
    await refreshOnce();
    setInterval(refreshOnce, POLL_INTERVAL_MS);
  })();

})();
</script>

</body>
</html>
